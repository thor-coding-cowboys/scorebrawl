name: Preview Environment

on:
  pull_request:
    types: [opened, synchronize, reopened, closed]

jobs:
  deploy-preview:
    if: github.event.action != 'closed'
    runs-on: ubuntu-slim
    permissions:
      contents: read
      pull-requests: write
    steps:
      - name: ğŸ“¥ Checkout
        uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 #v5.0.0

      - name: ğŸ¥Ÿ Setup Bun
        uses: oven-sh/setup-bun@735343b667d3e6f658f44d0eca948eb6282f2b76 # v2.0.2
        with:
          bun-version: latest

      - name: ğŸ“¦ Install dependencies
        run: bun install

      - name: ğŸ—ï¸ Build
        run: bun run build

      - name: ğŸ—„ï¸ Create D1 Database
        id: create-db
        run: bun run .github/scripts/preview/create-d1-db.ts
        env:
          PR_NUMBER: ${{ github.event.pull_request.number }}
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}

      - name: ğŸ” Get D1 Database ID
        id: get-db
        run: bun run .github/scripts/preview/get-d1-db-id.ts
        env:
          PR_NUMBER: ${{ github.event.pull_request.number }}
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}

      - name: ğŸ“¦ Create R2 Buckets
        id: create-r2
        run: bun run .github/scripts/preview/create-r2-bucket.ts
        env:
          PR_NUMBER: ${{ github.event.pull_request.number }}
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}

      - name: ğŸ”„ Prepare wrangler config for preview
        id: prepare-config
        run: bun run .github/scripts/preview/prepare-wrangler-config.ts
        env:
          PR_NUMBER: ${{ github.event.pull_request.number }}
          DB_ID: ${{ steps.get-db.outputs.database_id }}
          DB_NAME: ${{ steps.get-db.outputs.database_name }}
          BUCKET_NAME: ${{ steps.create-r2.outputs.bucket_name }}
          ORG_BUCKET_NAME: ${{ steps.create-r2.outputs.org_bucket_name }}

      - name: ğŸ”„ Run Database Migrations
        run: |
          bun wrangler d1 migrations apply DB --remote --config wrangler.preview.jsonc
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}

      - name: ğŸ” Set BETTER_AUTH_SECRET
        run: bun run .github/scripts/preview/set-better-auth-secret.ts
        env:
          WORKER_NAME: ${{ steps.prepare-config.outputs.worker_name }}
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          GITHUB_CLIENT_SECRET: ${{ secrets.GITHUB_CLIENT_SECRET }}

      - name: ğŸš€ Deploy to Cloudflare Workers
        uses: cloudflare/wrangler-action@v3
        id: deploy
        with:
          apiToken: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          accountId: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          command: deploy --config wrangler.preview.jsonc

      - name: ğŸ“‹ Get preview URL
        id: get-url
        run: |
          PREVIEW_URL="https://${{ steps.prepare-config.outputs.worker_name }}.coding-cowboys.workers.dev"
          echo "preview_url=$PREVIEW_URL" >> $GITHUB_OUTPUT

      - name: ğŸ’¬ Comment on PR
        uses: actions/github-script@v7
        with:
          script: |
            const prNumber = context.issue.number;
            const previewUrl = '${{ steps.get-url.outputs.preview_url }}';
            const dbName = '${{ steps.get-db.outputs.database_name }}';

            const bucketName = '${{ steps.create-r2.outputs.bucket_name }}';
            const orgBucketName = '${{ steps.create-r2.outputs.org_bucket_name }}';
            const comment = `## ğŸš€ Preview Environment Deployed

            **Preview URL:** <a href="${previewUrl}" target="_blank">${previewUrl}</a>
            **Database:** \`${dbName}\`
            **R2 Buckets:** \`${bucketName}\`, \`${orgBucketName}\`

            This preview environment will be automatically cleaned up when the PR is closed.`;

            // Find existing comment
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prNumber,
            });

            const botComment = comments.find(comment =>
              comment.user.type === 'Bot' &&
              comment.body.includes('Preview Environment Deployed')
            );

            if (botComment) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body: comment
              });
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: prNumber,
                body: comment
              });
            }

  cleanup-preview:
    if: github.event.action == 'closed'
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
    steps:
      - name: ğŸ“¥ Checkout
        uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 #v5.0.0

      - name: ğŸ¥Ÿ Setup Bun
        uses: oven-sh/setup-bun@735343b667d3e6f658f44d0eca948eb6282f2b76 # v2.0.2
        with:
          bun-version: latest

      - name: ğŸ“¦ Install dependencies
        run: bun install

      - name: ğŸ—‘ï¸ Delete Worker
        uses: cloudflare/wrangler-action@v3
        continue-on-error: true
        with:
          apiToken: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          accountId: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          command: delete --name "scorebrawl-pr-${{ github.event.pull_request.number }}" --force

      - name: ğŸ—‘ï¸ Delete D1 Database
        continue-on-error: true
        run: bun run .github/scripts/preview/delete-d1-db.ts
        env:
          PR_NUMBER: ${{ github.event.pull_request.number }}
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}

      - name: ğŸ—‘ï¸ Delete R2 Buckets
        continue-on-error: true
        run: bun run .github/scripts/preview/delete-r2-bucket.ts
        env:
          PR_NUMBER: ${{ github.event.pull_request.number }}
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}

      - name: ğŸ’¬ Comment on PR
        uses: actions/github-script@v7
        with:
          script: |
            const prNumber = context.issue.number;

            const comment = `## ğŸ§¹ Preview Environment Cleaned Up

            The preview environment, database, and R2 bucket have been deleted.`;

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prNumber,
              body: comment
            });
